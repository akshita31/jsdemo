<script nonce>
    const editorOrigin = "http://localhost:27261";

    if (window.addEventListener) {
        window.addEventListener('message', (m) => {
            if (m.origin === editorOrigin) {
                if (m.data.type === "HostListenerReady") {
                    defineSampleTheme();
                    initializeEditor('sampleTheme');
                    showEditor();
                }

                else if (m.data.type === "RunCompleted") {
                    setOutput(m.data.output);
                }
            }
        });
    }

    function postMessageToEditor(message) {

        document.getElementById('trydotnet-editor')
            .contentWindow.postMessage(message, editorOrigin);
    }

    function run() {
        postMessageToEditor({ type: "run" });
    }

    function checkNextEnabled() {
        postMessageToEditor({ type: "checkNextEnabled" });
    }
    function checkPrevEnabled() {
        postMessageToEditor({ type: "checkPrevEnabled" });
    }
    function checkBackEnabled() {
        postMessageToEditor({ type: "checkBackEnabled" });
    }
    function nextInstrumentationStep() {
        postMessageToEditor({ type: "nextInstrumentationStep" });
    }
    function prevInstrumentationStep() {
        postMessageToEditor({ type: "prevInstrumentationStep" });
    }
    function setInstrumentation() {
        postMessageToEditor({ type: "setInstrumentation", enabled: true });
    }

    function setSourceCode() {
        postMessageToEditor({
            type: "setSourceCode",
            sourceCode: "Console.WriteLine(\"something new\"); // With a comment"
        });
    }

    function setWorkspaceFromGist() {
        postMessageToEditor({
            type: "setWorkspaceFromGist",
            gistId: "df44833326fcc575e8169fccb9d41fc7",
            bufferId: "FibonacciGenerator.cs",
            workspaceType: "console"
        });
    }

    function setWorkspace() {
        postMessageToEditor({
            type: "setWorkspace",
            workspace: {
                workspaceType: "nodatime.api",
                files: [{
                    name: "Program.cs",
                    text: "using System;\nusing System.Linq;\n\nnamespace FibonacciTest\n{\n public class Program\n {\n public static void Main()\n {\n #region codeRegion\n #endregion\n }\n }\n}"
                }],
                buffers: [{
                    id: "Program.cs@codeRegion",
                    content: "Console.WriteLine(\"something new here\");",
                    position: 0
                }]
            },
            bufferId: "Program.cs@codeRegion"
        });
    }

    function setWorkspaceFromGistAndShowPanel() {
        postMessageToEditor({
            type: "setWorkspaceFromGist",
            gistId: "df44833326fcc575e8169fccb9d41fc7",
            bufferId: "FibonacciGenerator.cs",
            canShowGitHubPanel: true
        });
    }

    function setUsings() {
        postMessageToEditor({
            type: "setAdditionalUsings",
            additionalUsings: ["System.Threading.Tasks"]
        });
    }

    function setTheme(theme) {
        postMessageToEditor({
            type: "configureMonacoEditor",
            theme
        })
    }

    function setVsDarkTheme() {
        setTheme('vs-dark');
    }

    function setNewTheme() {
        setTheme('newTheme');
    }

    function defineSampleTheme() {
        postMessageToEditor({
            type: "defineMonacoEditorThemes",
            themes: {
                sampleTheme: {
                    base: 'vs',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: 'ffa500', fontStyle: 'italic underline' },
                        { token: 'identifier', foreground: '008800', fontStyle: 'bold' },
                        { token: 'predefined', foreground: '0000ff' }
                    ]
                }
            }
        })
    }

    function defineNewTheme() {
        postMessageToEditor({
            type: "defineMonacoEditorThemes",
            themes: {
                newTheme: {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: 'ff0000', fontStyle: 'italic underline' }
                    ]
                }
            }
        })
    }

    function initializeEditor(theme) {
        postMessageToEditor({
            type: "configureMonacoEditor",
            editorOptions: {
                minimap: {
                    enabled: false
                },
                theme
            },
            theme
        })
    }

    function showEditor() {
        postMessageToEditor({
            type: "showEditor"
        })
    }

    function focusEditor() {
        postMessageToEditor({
            type: "focusEditor"
        })
    }

    function enableMinimap() {
        postMessageToEditor({
            type: "configureMonacoEditor",
            editorOptions: {
                minimap: {
                    enabled: true
                }
            }
        })
    }

    function applyScaffolding() {
        postMessageToEditor({ type: "applyScaffolding", fileName: "file.cs", scaffoldingType: "Method" });
    }

    if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('runButton').addEventListener('click', run);
            document.getElementById('setWorkspaceButton').addEventListener('click', setWorkspace);
        });
    }

    function setOutput(output) {
        document.getElementById('trydotnet-output').innerText = output;
    }

</script>


<div style="height:250px; padding:8px 0px">
    <iframe style="position:relative;top:0px;width:100%;height:100%" id="trydotnet-editor"></iframe>
</div>
<div>
    <button id="runButton">run</button>
    Runs the current source code. The result is sent back in a RunCompleted message.
    <pre>{
type: "run"
}
    </pre>
</div>
<p class="trydotnet-outputlabel">Output:</p>
<pre><code id="trydotnet-output"></code></pre>
</div>

<div>
    <button id="setWorkspaceButton">Set source code from workspace</button>

    <script>
        var editor = document.getElementById('trydotnet-editor');
        if (editor != null) {
            editor.setAttribute("src", "http://localhost:27261/v2/editor?hostOrigin=http:%2F%2Flocalhost:58737&waitForConfiguration=true&debug=true");
        }
    </script>